<html>
  <head>
    <script src="three.js/three.js"></script>
    <script src="three.js/TrackballControls.js"></script>
    <script src="three.js/extras/helpers/ArrowHelper.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src="pnav.js"></script>

    <title>Potential field navigation</title>
  </head>
  <body>
    <script>
$(function() {
  var camera;
  var scene;
  var renderer;
  var geometry;
  var material;
  var mesh;

  var field = new pnav.fields.PotentialField();
  //field.addBehavior(new pnav.behaviors.GoalSeeking(5000, 5000, 0, 1000));
  field.addBehavior(new pnav.behaviors.CylinderObstacle(0, 1000, 500, 2000));

  init();
  animate();

  function vectorArrow(scene, x, y, z, v) {
    if (v.magnitude() < 0.0001) {
      return;
    }
    var v = v.copy();
    v.scale(400);
    var material = new THREE.LineBasicMaterial({ color: 0xff0000 });
    //var geometry = new THREE.Mesh(new THREE.CylinderGeometry(1, 1, 2, 1, 2, false), material);
    //cylinder.applyMatrix(new THREE.Matrix4().translate(new THREE.Vector3(v[0], v[1], v[2])));
    //cylinder.overdraw = true;
    //var geometry = new THREE.CubeGeometry(1, 1, 1);
    //geometry.applyMatrix(new THREE.Matrix4().translate(new THREE.Vector3(x, y, z)));
    var geometry = new THREE.Geometry();
    geometry.vertices.push(new THREE.Vertex(new THREE.Vector3(x, y, z)));
    geometry.vertices.push(new THREE.Vertex(new THREE.Vector3(x + v.x, y + v.y, z + v.z)));
    geometry.vertices.push(new THREE.Vertex(new THREE.Vector3(x, y, z)));
    var line = new THREE.Line(geometry, material);
    scene.add(line);

    var sphere = new THREE.SphereGeometry(20, 5, 5);
    sphere.applyMatrix(new THREE.Matrix4().translate(new THREE.Vector3(x + v.x, y + v.y, z + v.z)));
    var sphereMesh = new THREE.Mesh(sphere, new THREE.MeshBasicMaterial({ color: 0x0000ff }));
    scene.add(sphereMesh);
  }

  function init() {

    camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 10000);
    //camera.position.x = 50
    //camera.position.y = -20
    camera.position.z = 20000;
    camera.lookAt(new THREE.Vector3(5000, 5000, 0));

    scene = new THREE.Scene();
    scene.add(camera);

    for (x = -5000; x < 5000; x += 700) {
      for (y = -5000; y < 5000; y += 700) {
        for (z = 0; z < 5000; z += 700) {
          var v = field.vectorAt(new Vector3(x, y, z));
          vectorArrow(scene, x, y, z, v);
          //scene.add(vectorArrow(x, y, z, new Vector3(1, 0, 0)));
        }
      }
    }
    material = new THREE.MeshBasicMaterial( { color: 0xff0000, wireframe: true } );

    renderer = new THREE.WebGLRenderer();
    renderer.setSize( window.innerWidth, window.innerHeight );

    // trackback _controls settings.
    var radius = 60;
    controls = new THREE.TrackballControls(camera, renderer.domElement);
    controls.rotateSpeed = 0.5;
    controls.zoomSpeed = 1.2;
    controls.panSpeed = 0.2;
    controls.noZoom = false;
    controls.noPan = false;
    controls.staticMoving = false;
    controls.dynamicDampingFactor = 0.3;
    controls.minDistance = radius * 1.1;
    controls.maxDistance = radius * 100;
    controls.keys = [65, 83, 68]; // [ rotateKey, zoomKey, panKey ]

    document.body.appendChild( renderer.domElement );

  }

  function animate() {

    // note: three.js includes requestAnimationFrame shim
    requestAnimationFrame( animate );

    controls.update();
    renderer.render( scene, camera );

  }
});
    </script>
  </body>
</html>
